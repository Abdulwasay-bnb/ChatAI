{% extends "skeleton.html" %}
{%block content%}
<!-- Hero Welcome Section -->
<section class="hero-gradient rounded-3xl p-10 shadow-xl mt-20 mb-12 max-w-5xl mx-auto glass-card flex flex-col md:flex-row items-center gap-8 transition-colors duration-300 bg-light-primary text-light-text dark:bg-dark-primary dark:text-dark-text">
    <div class="flex-1 text-center md:text-left">
        <h1 class="text-4xl md:text-5xl font-black mb-4 gradient-text">Welcome to Your Dashboard</h1>
        <div id="userInfo" class="mb-2 text-lg text-light-text dark:text-dark-text"></div>
        <p class="text-light-text dark:text-dark-text max-w-lg mx-auto md:mx-0">Manage your business, chatbots, and settings all in one place. Everything you need to scale your AI-powered customer experience.</p>
    </div>
    <div class="flex-1 flex justify-center">
        <div class="w-40 h-40 rounded-full bg-gradient-to-br from-purple-500 via-cyan-500 to-emerald-500 neon-glow floating flex items-center justify-center">
            <svg class="w-24 h-24 text-white/80" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 48 48">
                <circle cx="24" cy="24" r="20" stroke="currentColor" stroke-width="3" fill="none"/>
                <path d="M16 32c2-4 8-4 10 0" stroke="currentColor" stroke-width="2"/>
                <circle cx="18" cy="20" r="2" fill="currentColor"/>
                <circle cx="30" cy="20" r="2" fill="currentColor"/>
            </svg>
        </div>
    </div>
</section>

<!-- Stats Cards -->
<section class="max-w-5xl mx-auto mb-12 text-light-text dark:text-dark-text">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <div class="glass-card rounded-2xl p-6 text-center group hover:scale-105 transition-all perspective-card bg-light-primary text-light-text dark:bg-dark-primary dark:text-dark-text">
            <div class="text-3xl font-black gradient-text mb-1" id="stat-chatbots">--</div>
            <div class="text-light-text dark:text-dark-text text-sm">Chatbots</div>
        </div>
        <div class="glass-card rounded-2xl p-6 text-center group hover:scale-105 transition-all perspective-card bg-light-primary text-light-text dark:bg-dark-primary dark:text-dark-text">
            <div class="text-3xl font-black gradient-text mb-1" id="stat-business">--</div>
            <div class="text-light-text dark:text-dark-text text-sm">Business</div>
        </div>
        <div class="glass-card rounded-2xl p-6 text-center group hover:scale-105 transition-all perspective-card bg-light-primary text-light-text dark:bg-dark-primary dark:text-dark-text">
            <div class="text-3xl font-black gradient-text mb-1">âˆž</div>
            <div class="text-light-text dark:text-dark-text text-sm">Unlimited Users</div>
        </div>
        <div class="glass-card rounded-2xl p-6 text-center group hover:scale-105 transition-all perspective-card bg-light-primary text-light-text dark:bg-dark-primary dark:text-dark-text">
            <div class="text-3xl font-black gradient-text mb-1">24/7</div>
            <div class="text-light-text dark:text-dark-text text-sm">Support</div>
        </div>
    </div>
</section>

<!-- Main Content: Business Settings & Chatbots -->
<section class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8 mb-20 text-light-text  dark:text-dark-text">
    <!-- Business Settings -->
    <div class="glass-card rounded-3xl p-8 shadow-lg S  transition-colors duration-300 bg-light-primary text-light-text dark:bg-dark-primary dark:text-dark-text">
        <h2 class="font-bold text-2xl mb-4 gradient-text">Business Settings</h2>
        <form id="settingsForm" class="space-y-3">
            <input type="text" id="businessName" class="w-full border dark:border-white rounded px-3 py-2 bg-light-primary text-light-text dark:bg-dark-primary dark:text-dark-text border-light-primary dark:border-dark-primary" placeholder="Business Name" required />
            <textarea id="businessSettings" class="w-full border dark:border-white rounded px-3 py-2 bg-light-primary text-light-text dark:bg-dark-primary dark:text-dark-text border-light-primary dark:border-dark-primary" placeholder="Settings (JSON)"></textarea>
            <button type="submit" class="bg-gradient-to-r from-blue-600 to-cyan-600 text-white px-4 py-2 rounded hover:scale-105 transition-all font-semibold">Update Settings</button>
        </form>
        <div id="settingsMsg" class="text-green-600 dark:text-green-400 mt-2 hidden">Settings updated!</div>
    </div>
    <!-- Chatbots List -->
    <div class="glass-card rounded-3xl p-8 shadow-lg border border-green-100 dark:border-dark-primary transition-colors duration-300 flex flex-col bg-light-primary text-light-text dark:bg-dark-primary dark:text-dark-text">
        <div class="flex items-center justify-between mb-4">
            <h2 class="font-bold text-2xl gradient-text">Your Chatbots</h2>
            <button onclick="document.getElementById('chatbotForm').classList.toggle('hidden')" class="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-4 py-2 rounded-full font-bold shadow hover:scale-105 transition-all">+ New</button>
        </div>
        <ul id="chatbotList" class="mb-4 space-y-3"></ul>
        <form id="chatbotForm" class="space-y-2 hidden">
            <input type="text" id="chatbotName" class="w-full border dark:border-white rounded px-3 py-2 bg-light-primary text-light-text dark:bg-dark-primary dark:text-dark-text border-light-primary dark:border-dark-primary" placeholder="Chatbot Name" required />
            <textarea id="chatbotPrompt" class="w-full border dark:border-white border rounded px-3 py-2 bg-light-primary text-light-text dark:bg-dark-primary dark:text-dark-text border-light-primary dark:border-dark-primary" placeholder="Prompt"></textarea>
            <div class="flex gap-2">
                <button type="submit" class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-4 py-2 rounded font-semibold hover:scale-105 transition-all">Create</button>
                <button type="button" onclick="document.getElementById('chatbotForm').classList.add('hidden')" class="px-4 py-2 rounded border border-black-900/50  text-light-text dark:text-dark-text dark:bg-red-700 hover:bg-slate-900/50 hover:text-white dark:hover:bg-red-700/40 transition-all">Cancel</button>
            </div>
        </form>
        <div id="chatbotMsg" class="text-green-600 dark:text-green-400 mt-2 hidden">Chatbot created!</div>
    </div>
</section>
{%endblock%}
{%block extrajs%}
<script>
    const userId = {{ user_id|tojson }};
    let businessProfileId = {{ user.business_profile_id|tojson }};

    async function loadUserInfo() {
        // Fetch user info
        const res = await fetch(`/api/v1/auth/user/${userId}`);
        if (!res.ok) return;
        const user = await res.json();
        document.getElementById('userInfo').innerHTML = `<span class="font-semibold gradient-text">${user.full_name || user.email}</span>`;
        loadBusinessSettings();
        loadChatbots();
        // Stats
        document.getElementById('stat-business').innerText = user.business_profile_id ? '1' : '0';
    }

    async function loadBusinessSettings() {
        if (!businessProfileId) return;
        const res = await fetch(`/api/v1/tenant/${businessProfileId}`);
        if (!res.ok) return;
        const profile = await res.json();
        document.getElementById('businessName').value = profile.name;
        document.getElementById('businessSettings').value = JSON.stringify(profile.settings, null, 2);
    }

    document.getElementById('settingsForm').onsubmit = async function(e) {
        e.preventDefault();
        const name = document.getElementById('businessName').value;
        let settings;
        try {
            settings = JSON.parse(document.getElementById('businessSettings').value);
        } catch {
            document.getElementById('settingsMsg').innerText = 'Invalid JSON in settings!';
            document.getElementById('settingsMsg').classList.remove('hidden');
            return;
        }
        const res = await fetch(`/api/v1/tenant/${businessProfileId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, settings })
        });
        if (res.ok) {
            document.getElementById('settingsMsg').innerText = 'Settings updated!';
            document.getElementById('settingsMsg').classList.remove('hidden');
        } else {
            document.getElementById('settingsMsg').innerText = 'Failed to update settings.';
            document.getElementById('settingsMsg').classList.remove('hidden');
        }
    };

    async function loadChatbots() {
        const res = await fetch(`/api/v1/chatbot/?business_profile_id=${businessProfileId}`);
        if (!res.ok) return;
        const bots = await res.json();
        const list = document.getElementById('chatbotList');
        list.innerHTML = '';
        bots.forEach(bot => {
            const li = document.createElement('li');
            li.className = 'glass-card p-4 rounded-xl flex flex-col gap-1 shadow border border-slate-200 dark:border-slate-700';
            li.innerHTML = `
                <span class="font-bold text-lg gradient-text">${bot.name}</span> <span class="text-xs text-gray-500">(ID: ${bot.id})</span>
                <div class="text-xs text-gray-600 truncate">Prompt: ${bot.prompt}</div>
                <div class="flex gap-2 mt-2">
                    <button class="edit-btn px-2 py-1 rounded bg-blue-500 text-white text-xs hover:bg-blue-600 transition" data-id="${bot.id}">Edit</button>
                    <button class="embed-btn px-2 py-1 rounded bg-emerald-500 text-white text-xs hover:bg-emerald-600 transition" data-id="${bot.id}">Get Embed</button>
                </div>
                <form class="edit-form space-y-2 mt-2 hidden" data-id="${bot.id}">
                    <input type="text" class="edit-name w-full border rounded px-2 py-1" value="${bot.name}" required />
                    <textarea class="edit-prompt w-full border rounded px-2 py-1">${bot.prompt}</textarea>
                    <div class="flex gap-2">
                        <button type="submit" class="bg-blue-600 text-white px-3 py-1 rounded">Save</button>
                        <button type="button" class="cancel-edit px-3 py-1 rounded border">Cancel</button>
                    </div>
                </form>
                <div class="embed-snippet mt-2 hidden"></div>
            `;
            list.appendChild(li);
        });
        document.getElementById('stat-chatbots').innerText = bots.length;

        // Add event listeners for edit and embed buttons
        document.querySelectorAll('.edit-btn').forEach(btn => {
            btn.onclick = function() {
                const id = this.getAttribute('data-id');
                const form = this.parentElement.parentElement.querySelector('.edit-form');
                form.classList.remove('hidden');
            };
        });
        document.querySelectorAll('.cancel-edit').forEach(btn => {
            btn.onclick = function() {
                this.closest('.edit-form').classList.add('hidden');
            };
        });
        document.querySelectorAll('.edit-form').forEach(form => {
            form.onsubmit = async function(e) {
                e.preventDefault();
                const id = form.getAttribute('data-id');
                const name = form.querySelector('.edit-name').value;
                const prompt = form.querySelector('.edit-prompt').value;
                const res = await fetch(`/api/v1/chatbot/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, prompt, owner_id: userId, business_profile_id: businessProfileId })
                });
                if (res.ok) {
                    loadChatbots();
                } else {
                    alert('Failed to update chatbot.');
                }
            };
        });
        document.querySelectorAll('.embed-btn').forEach(btn => {
            btn.onclick = async function() {
                const id = this.getAttribute('data-id');
                // Use the user's id for embed link
                const res = await fetch(`/api/v1/chatbot/embed/${userId}`);
                if (!res.ok) return alert('Failed to get embed link');
                const data = await res.json();
                const embedCode = `&lt;script data-user-id=\"${userId}\" src=\"${data.embed_link}\"&gt;&lt;/script&gt;`;
                const snippetDiv = this.parentElement.parentElement.querySelector('.embed-snippet');
                snippetDiv.innerHTML = `<div class='bg-slate-100 dark:bg-slate-800 p-2 rounded text-xs font-mono flex items-center gap-2'><span id='embed-code'>${embedCode}</span><button class='copy-embed px-2 py-1 bg-slate-300 dark:bg-slate-700 rounded text-xs'>Copy</button></div>`;
                snippetDiv.classList.remove('hidden');
                // Copy button
                snippetDiv.querySelector('.copy-embed').onclick = function() {
                    navigator.clipboard.writeText(embedCode);
                    this.innerText = 'Copied!';
                    setTimeout(() => { this.innerText = 'Copy'; }, 1200);
                };
            };
        });
    }

    document.getElementById('chatbotForm').onsubmit = async function(e) {
        e.preventDefault();
        const name = document.getElementById('chatbotName').value;
        const prompt = document.getElementById('chatbotPrompt').value;
        const res = await fetch('/api/v1/chatbot/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, prompt, owner_id: userId, business_profile_id: businessProfileId })
        });
        if (res.ok) {
            document.getElementById('chatbotMsg').innerText = 'Chatbot created!';
            document.getElementById('chatbotMsg').classList.remove('hidden');
            loadChatbots();
            document.getElementById('chatbotForm').classList.add('hidden');
        } else {
            document.getElementById('chatbotMsg').innerText = 'Failed to create chatbot.';
            document.getElementById('chatbotMsg').classList.remove('hidden');
        }
    };

    loadUserInfo();
</script>
{%endblock%} 