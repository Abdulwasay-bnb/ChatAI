<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

<div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-600 via-cyan-600 to-emerald-600 dark:from-black dark:via-slate-900 dark:to-gray-900 transition-colors duration-300">
  <div class="flex flex-col h-[600px] w-full max-w-md mx-auto glass-card shadow-2xl rounded-3xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-black/40 backdrop-blur-xl overflow-hidden">
    <!-- Header -->
    <div class="flex items-center justify-between px-6 py-4 bg-gradient-to-r from-purple-500 via-cyan-500 to-emerald-500 dark:from-purple-800 dark:via-cyan-900 dark:to-emerald-900 text-white">
      <div class="flex items-center gap-2">
        <span class="w-3 h-3 bg-emerald-400 rounded-full animate-pulse"></span>
        <span class="font-bold text-lg tracking-wide">AI Chatbot</span>
      </div>
      <span class="text-xs opacity-80">Powered by ChatAI</span>
    </div>
    <!-- Messages -->
    <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-white/60 dark:bg-black/30 transition-colors duration-300"></div>
    <!-- Input -->
    <form id="chatForm" class="flex p-3 border-t border-slate-200 dark:border-slate-700 bg-white/70 dark:bg-black/40">
      <input id="chatInput" type="text" class="flex-1 border-none rounded-xl px-4 py-2 mr-2 focus:outline-none focus:ring-2 focus:ring-cyan-400 dark:bg-slate-800 dark:text-white bg-white text-gray-900 placeholder-gray-400 dark:placeholder-gray-500 shadow-inner transition-all" placeholder="Type your message..." autocomplete="off" />
      <button type="submit" class="bg-gradient-to-r from-cyan-500 to-emerald-500 hover:from-purple-500 hover:to-cyan-500 text-white px-5 py-2 rounded-xl font-semibold shadow-lg transition-all">Send</button>
    </form>
  </div>
</div>
<script>
    const userId = {{ user_id }};
    let chatbotId = null;
    const messagesDiv = document.getElementById('messages');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');
    let waitingForResponse = false;

    function addMessage(content, from) {
        const msg = document.createElement('div');
        msg.className = from === 'user'
            ? 'flex justify-end'
            : 'flex justify-start';
        msg.innerHTML = `<span class="inline-block px-4 py-2 rounded-2xl shadow-md max-w-[80%] break-words font-medium ${from === 'user'
            ? 'bg-gradient-to-r from-cyan-500 to-emerald-500 text-white dark:from-cyan-700 dark:to-emerald-700'
            : 'bg-white/80 dark:bg-slate-900/70 text-gray-900 dark:text-gray-100 border border-slate-200 dark:border-slate-700'}">${content}</span>`;
        messagesDiv.appendChild(msg);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function fetchChatbotId() {
        // Fetch all chatbots and pick the first one for this user
        const res = await fetch('/api/v1/chatbot/?user_id=' + userId);
        const bots = await res.json();
        if (Array.isArray(bots) && bots.length > 0) {
            chatbotId = bots[0].id;
        } else {
            chatbotId = null;
        }
    }

    async function init() {
        await fetchChatbotId();
        if (!chatbotId) {
            addMessage('No chatbot found for this user.', 'bot');
            chatInput.disabled = true;
            return;
        }
    }

    chatForm.onsubmit = async function(e) {
        e.preventDefault();
        if (waitingForResponse) return; // Prevent multiple sends
        const prompt = chatInput.value.trim();
        if (!prompt || !chatbotId) return;
        addMessage(prompt, 'user');
        chatInput.value = '';
        chatInput.disabled = true;
        waitingForResponse = true;
        addMessage('<span class="animate-pulse">...</span>', 'bot'); // Show loading indicator

        try {
            const res = await fetch('/api/v1/chatbot/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt, user_id: userId, chatbot_id: chatbotId })
            });
            const data = await res.json();
            // Remove the loading indicator
            const lastMsg = messagesDiv.lastChild;
            if (lastMsg && lastMsg.textContent === '...') {
                messagesDiv.removeChild(lastMsg);
            }
            addMessage(data.response || JSON.stringify(data), 'bot');
        } catch (err) {
            // Remove the loading indicator
            const lastMsg = messagesDiv.lastChild;
            if (lastMsg && lastMsg.textContent === '...') {
                messagesDiv.removeChild(lastMsg);
            }
            addMessage('Error: Could not get response from bot.', 'bot');
        }
        chatInput.disabled = false;
        chatInput.focus();
        waitingForResponse = false;
    };

    init();
</script>
